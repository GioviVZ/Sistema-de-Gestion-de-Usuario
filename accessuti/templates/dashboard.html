{% extends "base.html" %}
{% block title %}Dashboard | Access UTI{% endblock %}

{% block content %}

<div class="page-head" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
  <div>
    <h2 class="h2">Panel de Control</h2>
    <div class="muted">Gesti√≥n integral de usuarios de red</div>
  </div>

  {% if user.role == "ADMIN" %}
    <button class="btn" onclick="openModal()">+ Registrar Usuario</button>
  {% endif %}
</div>

<!-- ================= FILTROS ================= -->
<div class="card" style="padding:20px; margin-bottom:25px;">
  <h3>Busqueda</h3>

  <form method="get" class="grid2">
    <div>
      <label>Nombre / Usuario de Red</label>
      <input class="input" name="nombre" value="{{ nombre }}">
    </div>

    <div>
      <label>Sede</label>
      <input class="input" name="sede" value="{{ sede }}">
    </div>

    <div>
      <label>Dependencia</label>
      <input class="input" name="dependencia" value="{{ dependencia }}">
    </div>

    <div>
      <label>Subdependencia</label>
      <input class="input" name="subdependencia" value="{{ subdependencia }}">
    </div>

    <div style="align-self:end;">
      <button class="btn">Filtrar</button>
    </div>
  </form>
</div>

<!-- ================= RESULTADOS FILTRADOS ================= -->
{% if filtered %}
<div class="card" style="padding:20px; margin-bottom:25px;">
  <h3>Resultados filtrados ({{ filtered|length }})</h3>

  {% for u in filtered %}
  <div style="padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">

    <div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <b>{{ u.usuario_red }}</b>
        {% if u.status == "ACTIVE" %}
          <span class="badge badge-ok">ACTIVO</span>
        {% else %}
          <span class="badge badge-bad">INACTIVO</span>
        {% endif %}
      </div>
      <div class="muted" style="margin-top:6px;">
        {{ u.nombres }} {{ u.apellidos }} ‚Äî {{ u.sede }} / {{ u.dependencia }}
      </div>
    </div>

    {% if user.role == "ADMIN" %}
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn ghost" onclick='editUser({{ u|tojson }})'>‚úè Editar</button>

      {% if u.status == "ACTIVE" %}
      <form method="post" action="{{ url_for('users.user_deactivate') }}">
        <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
        <button class="btn danger">‚õî Desactivar</button>
      </form>
      {% else %}
      <form method="post" action="{{ url_for('users.user_activate') }}">
        <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
        <button class="btn success">‚úÖ Reactivar</button>
      </form>
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- ================= KPIs ================= -->
<div class="grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:18px; margin-bottom:25px;">
  <div class="card" style="padding:18px;">
    <b>Total usuarios activos</b>
    <div style="font-size:34px;">{{ total }}</div>
  </div>

  <div class="card" style="padding:18px;">
    <b>Total Alertas</b>
    <div style="font-size:34px;">{{ alerts|length }}</div>
  </div>

  <div class="card" style="padding:18px;">
    <b>M√©tricas BST</b>
    <div class="muted">Comparaciones: {{ metrics.comparisons }}</div>
  </div>
</div>

<!-- ================= GRAFICOS ================= -->
<div class="grid" style="display:grid; grid-template-columns:1fr; gap:18px; margin-bottom:25px;">
  <div class="card" style="padding:20px;">
    <h3>Usuarios activos por sede</h3>
    <img src="{{ url_for('users.chart_users_by_sede') }}" style="width:100%; max-height:400px;">
  </div>

  <div class="card" style="padding:20px;">
    <h3>Usuarios activos por tipo de contrato</h3>
    <img src="{{ url_for('users.chart_users_by_contrato') }}" style="width:100%; max-height:400px;">
  </div>
</div>

<!-- ================= ALERTAS ================= -->
<div class="card" style="padding:20px; margin-bottom:25px;">
  <h3>‚ö† Pr√≥ximos vencimientos (ordenado por d√≠as restantes)</h3>

  {% for a in alerts %}
    {% set color = "#2fb7da" %}
    {% if a.dias <= 5 %}
      {% set color = "#ef4444" %}
    {% elif a.dias <= 10 %}
      {% set color = "#f59e0b" %}
    {% endif %}

    <div style="
      padding:15px;
      margin-top:12px;
      border-left:5px solid {{ color }};
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    ">

      <div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <b style="color:{{ color }}">{{ a.tipo }}</b>
          <span class="chip">vence: <b>{{ a.vence }}</b></span>
          <span class="chip">faltan: <b>{{ a.dias }}</b> d√≠as</span>
        </div>

        <div class="muted" style="margin-top:8px;">
          <b>{{ a.u.usuario_red }}</b> ‚Äî {{ a.u.nombres }} {{ a.u.apellidos }}
          | {{ a.u.sede }} / {{ a.u.dependencia }} / {{ a.u.subdependencia }}
        </div>

        <div class="muted" style="margin-top:6px;">
          Contrato fin: <b>{{ a.u.contrato_fin or "‚Äî" }}</b> |
          Permiso fin: <b>{{ a.u.permiso_fin or "‚Äî" }}</b> |
          VPN fin: <b>{{ a.u.vpn_fin or "‚Äî" }}</b>
        </div>
      </div>

      {% if user.role == "ADMIN" %}
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start;">
        <button class="btn ghost" onclick='editUser({{ a.u|tojson }})'>‚úè Editar</button>

        <form method="post" action="{{ url_for('users.user_deactivate') }}">
          <input type="hidden" name="usuario_red" value="{{ a.u.usuario_red }}">
          <button class="btn danger">‚õî Desactivar</button>
        </form>

        <form method="post" action="{{ url_for('users.user_perms_off') }}">
          <input type="hidden" name="usuario_red" value="{{ a.u.usuario_red }}">
          <button class="btn ghost">üîí Apagar permisos</button>
        </form>
      </div>
      {% endif %}
    </div>

  {% else %}
    <div class="muted">Sin alertas pr√≥ximas.</div>
  {% endfor %}
</div>

<!-- ================= MODAL ================= -->
<div id="modal" class="modal">
  <div class="modal-content" style="max-height:90vh; overflow-y:auto;">
    <span class="close" onclick="closeModal()">&times;</span>

    <h3 id="modalTitle">Registrar Usuario</h3>

    <form method="post" action="{{ url_for('users.register_network_user') }}" class="grid2">

      <div style="grid-column:1/-1;">
        <h4>Datos Personales</h4>
      </div>

      <div>
        <label>Usuario Red</label>
        <input class="input" name="usuario_red" required>
      </div>
      <div>
        <label>DNI</label>
        <input class="input" name="dni">
      </div>
      <div>
        <label>Nombres</label>
        <input class="input" name="nombres">
      </div>
      <div>
        <label>Apellidos</label>
        <input class="input" name="apellidos">
      </div>

      <div style="grid-column:1/-1;">
        <h4>Contrato</h4>
      </div>

      <div>
        <label>Tipo Contrato</label>
        <select class="input" name="tipo_contrato">
          <option value="">Seleccione</option>
          <option>CAS</option>
          <option>CAP</option>
          <option>TERCERO</option>
        </select>
      </div>
      <div>
        <label>Inicio Contrato</label>
        <input class="input" type="date" name="contrato_inicio">
      </div>
      <div>
        <label>Fin Contrato</label>
        <input class="input" type="date" name="contrato_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4>Ubicaci√≥n</h4>
      </div>

      <!-- buscadores internos -->
      <div>
        <label>Buscar Sede</label>
        <input class="input" id="searchSede" placeholder="escribe para filtrar...">
      </div>
      <div>
        <label>Sede</label>
        <select class="input" id="sedeSel" name="sede" required></select>
      </div>

      <div>
        <label>Buscar Dependencia</label>
        <input class="input" id="searchDep" placeholder="escribe para filtrar...">
      </div>
      <div>
        <label>Dependencia</label>
        <select class="input" id="depSel" name="dependencia"></select>
      </div>

      <div>
        <label>Buscar Subdependencia</label>
        <input class="input" id="searchSub" placeholder="escribe para filtrar...">
      </div>
      <div>
        <label>Subdependencia</label>
        <select class="input" id="subSel" name="subdependencia"></select>
      </div>

      <div style="grid-column:1/-1;">
        <h4>Permisos</h4>
      </div>

      <div>
        <label>Nivel de Acceso</label>
        <select class="input" name="acceso_nivel">
          <option value="NORMAL">NORMAL</option>
          <option value="COMUN">COMUN</option>
          <option value="LIBRE">LIBRE</option>
        </select>
      </div>

      <div>
        <label>Acceso Redes Sociales</label>
        <select class="input" name="acceso_redes_sociales">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label>Permiso Inicio</label>
        <input class="input" type="date" name="permiso_inicio">
      </div>
      <div>
        <label>Permiso Fin</label>
        <input class="input" type="date" name="permiso_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4>VPN</h4>
      </div>

      <div>
        <label>VPN Activo</label>
        <select class="input" name="vpn_activo">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label>VPN Inicio</label>
        <input class="input" type="date" name="vpn_inicio">
      </div>
      <div>
        <label>VPN Fin</label>
        <input class="input" type="date" name="vpn_fin">
      </div>

      <div style="grid-column:1/-1;">
        <button class="btn" style="width:100%; margin-top:10px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ================= MODAL OPEN/CLOSE ================= */
function openModal(){
  document.getElementById("modal").style.display = "block";
  document.getElementById("modalTitle").innerText = "Registrar Usuario";
}
function closeModal(){
  document.getElementById("modal").style.display = "none";
}

/* ================= ORG JSON + SELECTS ================= */
let orgData = {};
let sedeOptions = [];
let depOptions = [];
let subOptions = [];

const sedeSel = document.getElementById("sedeSel");
const depSel = document.getElementById("depSel");
const subSel = document.getElementById("subSel");

fetch("/static/data/org.json")
  .then(r => r.json())
  .then(data => {
    orgData = data;
    buildSedes();
  });

function setOptions(select, items){
  select.innerHTML = '<option value="">Seleccione</option>';
  items.forEach(v => select.innerHTML += `<option value="${v}">${v}</option>`);
}

function buildSedes(){
  sedeOptions = Object.keys(orgData || {});
  setOptions(sedeSel, sedeOptions);
  setOptions(depSel, []);
  setOptions(subSel, []);
}

sedeSel.addEventListener("change", () => {
  const sede = sedeSel.value;
  depOptions = sede && orgData[sede] ? Object.keys(orgData[sede]) : [];
  setOptions(depSel, depOptions);
  setOptions(subSel, []);
});

depSel.addEventListener("change", () => {
  const sede = sedeSel.value;
  const dep = depSel.value;
  subOptions = (sede && dep && orgData[sede] && orgData[sede][dep]) ? orgData[sede][dep] : [];
  setOptions(subSel, subOptions);
});

/* ================= BUSCADOR INTERNO (FILTRA SELECT) ================= */
function filterSelect(inputEl, selectEl){
  const q = (inputEl.value || "").toLowerCase().trim();
  const all = Array.from(selectEl.querySelectorAll("option")).map(o => o.value).filter(v => v);
  const base = selectEl.id === "sedeSel" ? sedeOptions : (selectEl.id === "depSel" ? depOptions : subOptions);
  const filtered = !q ? base : base.filter(x => x.toLowerCase().includes(q));
  setOptions(selectEl, filtered);
}

document.getElementById("searchSede").addEventListener("input", () => filterSelect(searchSede, sedeSel));
document.getElementById("searchDep").addEventListener("input", () => filterSelect(searchDep, depSel));
document.getElementById("searchSub").addEventListener("input", () => filterSelect(searchSub, subSel));

/* ================= EDITAR USUARIO ================= */
function editUser(data){
  openModal();
  document.getElementById("modalTitle").innerText = "Editar Usuario";

  // llenar inputs simples
  Object.keys(data).forEach(k => {
    const el = document.querySelector(`[name="${k}"]`);
    if(el && el.tagName !== "SELECT"){
      el.value = data[k] ?? "";
    }
  });

  // selects: sede -> dependencia -> subdependencia
  const sede = data.sede || "";
  const dep = data.dependencia || "";
  const sub = data.subdependencia || "";

  // reset buscadores
  document.getElementById("searchSede").value = "";
  document.getElementById("searchDep").value = "";
  document.getElementById("searchSub").value = "";

  // set sede
  buildSedes();
  sedeSel.value = sede;
  sedeSel.dispatchEvent(new Event("change"));

  // set dep y sub con peque√±os delays para que cargue la cascada
  setTimeout(() => {
    depSel.value = dep;
    depSel.dispatchEvent(new Event("change"));

    setTimeout(() => {
      subSel.value = sub;
    }, 120);
  }, 120);
}
</script>

{% endblock %}