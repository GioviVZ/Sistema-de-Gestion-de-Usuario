{% extends "base.html" %}
{% block title %}Dashboard | Access UTI{% endblock %}

{% block content %}

<div class="page-head" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
  <div>
    <h2 class="h2">Dashboard</h2>
    <div class="muted">Gesti√≥n integral de usuarios de red</div>
  </div>

  {% if user.role == "ADMIN" %}
    <button class="btn" onclick="openModal()">+ Registrar Usuario</button>
  {% endif %}
</div>

<!-- ================= GRAFICOS ================= -->
<div class="grid" style="display:grid; grid-template-columns:1fr; gap:18px; margin-bottom:25px;">
  <div class="card" style="padding:20px;">
    <h3>Usuarios activos por sede</h3>
    <img src="{{ url_for('users.chart_users_by_sede') }}?v={{ now_ts }}" style="width:100%; max-height:400px;">
  </div>

  <div class="card" style="padding:20px;">
    <h3>Usuarios activos por tipo de contrato</h3>
    <img src="{{ url_for('users.chart_users_by_contrato') }}?v={{ now_ts }}" style="width:100%; max-height:400px;">
  </div>

  <div class="card" style="padding:20px;">
    <h3>Alertas por tipo (pr√≥ximos 15 d√≠as)</h3>
    <img src="{{ url_for('users.chart_alerts_by_tipo') }}?v={{ now_ts }}" style="width:100%; max-height:400px;">
  </div>
</div>

<!-- ================= KPIs ================= -->
<div class="grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:18px; margin-bottom:25px;">
  <div class="card" style="padding:18px;">
    <b>Total usuarios activos</b>
    <div style="font-size:34px;">{{ total }}</div>
  </div>

  <div class="card" style="padding:18px;">
    <b>Total alertas</b>
    <div style="font-size:34px;">{{ alerts|length }}</div>
  </div>

  <div class="card" style="padding:18px;">
    <b>M√©tricas BST</b>
    <div class="muted">Comparaciones: {{ metrics.comparisons }}</div>
  </div>
</div>

<!-- ================= FILTROS ================= -->
<div class="card" style="padding:20px; margin-bottom:25px;">
  <h3>B√∫squeda</h3>

  <form method="get" class="grid2">
    <div>
      <label>Nombre / Usuario de red</label>
      <input class="input" name="nombre" value="{{ nombre }}">
    </div>

    <div>
      <label>Sede</label>
      <input class="input" name="sede" value="{{ sede }}">
    </div>

    <div>
      <label>Dependencia</label>
      <input class="input" name="dependencia" value="{{ dependencia }}">
    </div>

    <div>
      <label>Subdependencia</label>
      <input class="input" name="subdependencia" value="{{ subdependencia }}">
    </div>

    <div style="align-self:end;">
      <button class="btn">Filtrar</button>
    </div>
  </form>
</div>

<!-- ================= RESULTADOS FILTRADOS ================= -->
{% if filtered %}
<div class="card" style="padding:20px; margin-bottom:25px;">
  <h3>Resultados filtrados ({{ filtered|length }})</h3>

  {% for u in filtered %}
  <div style="padding:12px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">

    <div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <b>{{ u.usuario_red }}</b>
        {% if u.status == "ACTIVE" %}
          <span class="badge badge-ok">ACTIVO</span>
        {% else %}
          <span class="badge badge-bad">INACTIVO</span>
        {% endif %}
      </div>
      <div class="muted" style="margin-top:6px;">
        {{ u.nombres }} {{ u.apellidos }} ‚Äî {{ u.sede }} / {{ u.dependencia }}
      </div>
    </div>

    {% if user.role == "ADMIN" %}
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn ghost" onclick='editUser({{ u|tojson }})'>‚úè Editar</button>

      {% if u.status == "ACTIVE" %}
      <form method="post" action="{{ url_for('users.user_deactivate') }}">
        <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
        <button class="btn danger">‚õî Desactivar</button>
      </form>
      {% else %}
      <form method="post" action="{{ url_for('users.user_activate') }}">
        <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
        <button class="btn success">‚úÖ Reactivar</button>
      </form>
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- ================= ALERTAS ================= -->
<div class="card" style="padding:20px; margin-bottom:25px;">
  <h3>‚ö† Pr√≥ximos vencimientos</h3>

  {% for a in alerts %}
    {% set color = "#2fb7da" %}
    {% if a.dias <= 5 %}
      {% set color = "#ef4444" %}
    {% elif a.dias <= 10 %}
      {% set color = "#f59e0b" %}
    {% endif %}

    <div style="
      padding:15px;
      margin-top:12px;
      border-left:5px solid {{ color }};
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    ">

      <div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <b style="color:{{ color }}">{{ a.tipo }}</b>
          <span class="chip">vence: <b>{{ a.vence }}</b></span>
          <span class="chip">faltan: <b>{{ a.dias }}</b> d√≠as</span>
        </div>

        <div class="muted" style="margin-top:8px;">
          <b>{{ a.u.usuario_red }}</b> ‚Äî {{ a.u.nombres }} {{ a.u.apellidos }}
          | {{ a.u.sede }} / {{ a.u.dependencia }} / {{ a.u.subdependencia }}
        </div>

        <div class="muted" style="margin-top:6px;">
          Contrato fin: <b>{{ a.u.contrato_fin or "‚Äî" }}</b> |
          Permiso fin: <b>{{ a.u.permiso_fin or "‚Äî" }}</b> |
          VPN fin: <b>{{ a.u.vpn_fin or "‚Äî" }}</b>
        </div>
      </div>

      {% if user.role == "ADMIN" %}
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start;">
        <button class="btn ghost" onclick='editUser({{ a.u|tojson }})'>‚úè Editar</button>

        <form method="post" action="{{ url_for('users.user_deactivate') }}">
          <input type="hidden" name="usuario_red" value="{{ a.u.usuario_red }}">
          <button class="btn danger">‚õî Desactivar</button>
        </form>

        <form method="post" action="{{ url_for('users.user_perms_off') }}">
          <input type="hidden" name="usuario_red" value="{{ a.u.usuario_red }}">
          <button class="btn ghost">üîí Apagar permisos</button>
        </form>
      </div>
      {% endif %}
    </div>

  {% else %}
    <div class="muted">Sin alertas pr√≥ximas.</div>
  {% endfor %}
</div>

<!-- ================= MODAL ================= -->
<div id="modal" class="modal">
  <div class="modal-content" style="max-height:90vh; overflow-y:auto;">
    <span class="close" onclick="closeModal()">&times;</span>

    <h3 id="modalTitle">Registrar Usuario</h3>

    <form method="post" action="{{ url_for('users.register_network_user') }}" class="grid2" id="userForm">

      <div style="grid-column:1/-1;">
        <h4>Datos personales</h4>
      </div>

      <div>
        <label>Usuario red</label>
        <input class="input" name="usuario_red" required>
      </div>
      <div>
        <label>DNI</label>
        <input class="input" name="dni">
      </div>
      <div>
        <label>Nombres</label>
        <input class="input" name="nombres">
      </div>
      <div>
        <label>Apellidos</label>
        <input class="input" name="apellidos">
      </div>

      <div style="grid-column:1/-1;">
        <h4>Contrato</h4>
      </div>

      <div>
        <label>Tipo contrato</label>
        <select class="input" name="tipo_contrato" id="tipoContratoSel">
          <option value="">Seleccione</option>
          <option value="CAS">CAS</option>
          <option value="CAP">CAP</option>
          <option value="TERCERO">TERCERO</option>
        </select>
      </div>
      <div>
        <label>Inicio contrato</label>
        <input class="input" type="date" name="contrato_inicio">
      </div>
      <div>
        <label>Fin contrato</label>
        <input class="input" type="date" name="contrato_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4>Ubicaci√≥n</h4>
        <div class="muted" style="margin-top:-6px;">Select con buscador interno + cascada</div>
      </div>

      <div>
        <label>Buscar sede</label>
        <input class="input" id="searchSede" placeholder="Escribe para filtrar...">
      </div>
      <div>
        <label>Sede</label>
        <select class="input" name="sede" id="sedeSel">
          <option value="">Cargando...</option>
        </select>
      </div>

      <div>
        <label>Buscar dependencia</label>
        <input class="input" id="searchDep" placeholder="Escribe para filtrar...">
      </div>
      <div>
        <label>Dependencia</label>
        <select class="input" name="dependencia" id="depSel">
          <option value="">Seleccione sede</option>
        </select>
      </div>

      <div>
        <label>Buscar subdependencia</label>
        <input class="input" id="searchSub" placeholder="Escribe para filtrar...">
      </div>
      <div>
        <label>Subdependencia</label>
        <select class="input" name="subdependencia" id="subSel">
          <option value="">Seleccione dependencia</option>
        </select>
      </div>

      <div style="grid-column:1/-1;">
        <h4>Permisos</h4>
      </div>

      <div>
        <label>Nivel de acceso</label>
        <select class="input" name="acceso_nivel" id="accesoNivelSel">
          <option value="NORMAL">NORMAL</option>
          <option value="ADMINISTRADOR">ADMINISTRADOR</option>
        </select>
      </div>

      <div>
        <label>Acceso redes sociales</label>
        <select class="input" name="acceso_redes_sociales" id="redesSel">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label>Permiso inicio</label>
        <input class="input" type="date" name="permiso_inicio">
      </div>
      <div>
        <label>Permiso fin</label>
        <input class="input" type="date" name="permiso_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4>VPN</h4>
      </div>

      <div>
        <label>VPN activo</label>
        <select class="input" name="vpn_activo" id="vpnSel">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label>VPN inicio</label>
        <input class="input" type="date" name="vpn_inicio">
      </div>
      <div>
        <label>VPN fin</label>
        <input class="input" type="date" name="vpn_fin">
      </div>

      <div style="grid-column:1/-1;">
        <button class="btn" style="width:100%; margin-top:10px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ================= MODAL OPEN/CLOSE ================= */
function openModal(){
  document.getElementById("modal").style.display = "block";
  document.getElementById("modalTitle").innerText = "Registrar Usuario";
}
function closeModal(){
  document.getElementById("modal").style.display = "none";
}

/* ================= ORG JSON + SELECTS ================= */
let orgData = null;
let orgReady = false;

let sedeOptions = [];
let depOptions = [];
let subOptions = [];

const sedeSel = document.getElementById("sedeSel");
const depSel  = document.getElementById("depSel");
const subSel  = document.getElementById("subSel");

const searchSede = document.getElementById("searchSede");
const searchDep  = document.getElementById("searchDep");
const searchSub  = document.getElementById("searchSub");

function setOptions(select, items, placeholder="Seleccione"){
  if(!select) return;
  select.innerHTML = `<option value="">${placeholder}</option>`;
  (items || []).forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    select.appendChild(opt);
  });
}

function buildSedes(){
  sedeOptions = Object.keys(orgData || {});
  setOptions(sedeSel, sedeOptions, "Seleccione sede");
  setOptions(depSel, [], "Seleccione sede");
  setOptions(subSel, [], "Seleccione dependencia");
}

function filterList(base, q){
  q = (q || "").toLowerCase().trim();
  if(!q) return base;
  return base.filter(x => (x || "").toLowerCase().includes(q));
}

function refreshSede(){
  setOptions(sedeSel, filterList(sedeOptions, searchSede.value), "Seleccione sede");
  setOptions(depSel, [], "Seleccione sede");
  setOptions(subSel, [], "Seleccione dependencia");
}

function refreshDep(){
  setOptions(depSel, filterList(depOptions, searchDep.value), "Seleccione dependencia");
  setOptions(subSel, [], "Seleccione dependencia");
}

function refreshSub(){
  setOptions(subSel, filterList(subOptions, searchSub.value), "Seleccione subdependencia");
}

function ensureOrgLoaded(){
  if(orgReady) return Promise.resolve();

  const url = "{{ url_for('static', filename='data/org.json') }}";
  return fetch(url)
    .then(r => r.json())
    .then(data => {
      orgData = data || {};
      orgReady = true;
      buildSedes();
    })
    .catch(() => {
      orgData = {};
      orgReady = true;
      buildSedes();
    });
}

/* enganchar eventos SOLO si existen */
if(sedeSel){
  sedeSel.addEventListener("change", () => {
    const sede = sedeSel.value;
    depOptions = (sede && orgData && orgData[sede]) ? Object.keys(orgData[sede]) : [];
    searchDep.value = "";
    searchSub.value = "";
    setOptions(depSel, depOptions, "Seleccione dependencia");
    setOptions(subSel, [], "Seleccione dependencia");
  });
}

if(depSel){
  depSel.addEventListener("change", () => {
    const sede = sedeSel.value;
    const dep = depSel.value;
    subOptions = (sede && dep && orgData && orgData[sede] && orgData[sede][dep]) ? orgData[sede][dep] : [];
    searchSub.value = "";
    setOptions(subSel, subOptions, "Seleccione subdependencia");
  });
}

if(searchSede) searchSede.addEventListener("input", refreshSede);
if(searchDep)  searchDep.addEventListener("input", refreshDep);
if(searchSub)  searchSub.addEventListener("input", refreshSub);

/* ================= EDITAR USUARIO ================= */
function editUser(data){
  openModal();
  document.getElementById("modalTitle").innerText = "Editar Usuario";

  // llenar inputs y selects simples (no los de cascada)
  Object.keys(data).forEach(k => {
    const el = document.querySelector(`[name="${k}"]`);
    if(!el) return;

    // cascada se maneja abajo
    if(el.id === "sedeSel" || el.id === "depSel" || el.id === "subSel") return;

    el.value = (data[k] ?? "");
  });

  // cascada
  const sede = data.sede || "";
  const dep  = data.dependencia || "";
  const sub  = data.subdependencia || "";

  // reset buscadores
  searchSede.value = "";
  searchDep.value = "";
  searchSub.value = "";

  ensureOrgLoaded().then(() => {
    // set sede
    buildSedes();
    sedeSel.value = sede;
    sedeSel.dispatchEvent(new Event("change"));

    // set dep
    depSel.value = dep;
    depSel.dispatchEvent(new Event("change"));

    // set sub
    subSel.value = sub;
  });
}

/* carga org al abrir modal por primera vez (opcional) */
ensureOrgLoaded();
</script>

{% endblock %}