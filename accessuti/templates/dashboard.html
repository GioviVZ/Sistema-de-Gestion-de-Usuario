{% extends "base.html" %}
{% block title %}Dashboard | Access UTI{% endblock %}

{% block content %}

<!-- ================== HEADER ================== -->
<div class="page-head">
  <div>
    <h2 class="h2">AccessUTI</h2>
    <div class="muted">Gesti√≥n integral de usuarios de red (consulta + tablero)</div>
  </div>

  {% if user.role == "ADMIN" %}
    <button class="btn" type="button" onclick="openModal('create')">+ Registrar Usuario</button>
  {% endif %}
</div>

<!-- =========================================================
     SECCI√ìN 1: CONSULTA
========================================================= -->
<div class="card">
  <div class="card-head">
    <div>
      <h3 style="margin:0;">üîé Consulta</h3>
      <div class="muted">Busca usuarios y filtra por sede / dependencia / estado + permisos especiales</div>
    </div>
  </div>

  <form method="get" class="grid2" style="margin-top:14px;">
    <div>
      <label class="label">Nombre / Usuario de red</label>
      <input class="input" name="nombre" value="{{ nombre }}" placeholder="Ej: jlopez o Juan L√≥pez">
    </div>

    <div>
      <label class="label">Sede</label>
      <input class="input" name="sede" value="{{ sede }}" placeholder="Ej: Lima">
    </div>

    <div>
      <label class="label">Dependencia</label>
      <input class="input" name="dependencia" value="{{ dependencia }}" placeholder="Ej: UTI">
    </div>

    <div>
      <label class="label">Subdependencia</label>
      <input class="input" name="subdependencia" value="{{ subdependencia }}" placeholder="Ej: Mesa de Ayuda">
    </div>

    <div>
      <label class="label">Estado</label>
      <select class="input" name="estado">
        <option value="" {% if not estado %}selected{% endif %}>Activos (por defecto)</option>
        <option value="ACTIVE" {% if estado=="ACTIVE" %}selected{% endif %}>Solo ACTIVOS</option>
        <option value="INACTIVE" {% if estado=="INACTIVE" %}selected{% endif %}>Solo INACTIVOS</option>
      </select>
    </div>

    <div>
      <label class="label">Permisos activos</label>
      <select class="input" name="permisos_activos">
        <option value="" {% if not permisos_activos %}selected{% endif %}>Todos</option>
        <option value="SI" {% if permisos_activos=="SI" %}selected{% endif %}>SI</option>
        <option value="NO" {% if permisos_activos=="NO" %}selected{% endif %}>NO</option>
      </select>
    </div>

    <div>
      <label class="label">VPN</label>
      <select class="input" name="vpn_activo">
        <option value="" {% if not vpn_activo %}selected{% endif %}>Todos</option>
        <option value="SI" {% if vpn_activo=="SI" %}selected{% endif %}>SI</option>
        <option value="NO" {% if vpn_activo=="NO" %}selected{% endif %}>NO</option>
      </select>
    </div>

    <div>
      <label class="label">Redes sociales</label>
      <select class="input" name="acceso_redes_sociales">
        <option value="" {% if not acceso_redes_sociales %}selected{% endif %}>Todos</option>
        <option value="SI" {% if acceso_redes_sociales=="SI" %}selected{% endif %}>SI</option>
        <option value="NO" {% if acceso_redes_sociales=="NO" %}selected{% endif %}>NO</option>
      </select>
    </div>

    <div>
      <label class="label">Nivel de acceso</label>
      <select class="input" name="acceso_nivel">
        <option value="" {% if not acceso_nivel %}selected{% endif %}>Todos</option>
        <option value="NORMAL" {% if acceso_nivel=="NORMAL" %}selected{% endif %}>NORMAL</option>
        <option value="ADMINISTRADOR" {% if acceso_nivel=="ADMINISTRADOR" %}selected{% endif %}>ADMINISTRADOR</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">
      <label style="display:flex; gap:8px; align-items:center; margin:0;">
        <input type="checkbox" name="include_inactive" {% if include_inactive %}checked{% endif %}>
        <span class="muted">Mostrar tambi√©n desactivados</span>
      </label>
      <button class="btn" style="margin-left:auto;">Filtrar</button>
      <a class="btn ghost" href="{{ url_for('users.dashboard') }}">Limpiar</a>
    </div>
  </form>
</div>

<!-- ================= RESULTADOS ================= -->
<div class="card" style="margin-top:16px;">
  <div class="card-head">
    <div>
      <h3 style="margin:0;">üìã Resultados</h3>
      <div class="muted">
        {% if filtered %}{{ filtered|length }} resultado(s){% else %}Sin resultados{% endif %}
      </div>
    </div>

    <div class="muted" style="font-size:13px;">
      Mostrando: {% if estado %}<b>{{ estado }}</b>{% else %}<b>ACTIVE (por defecto)</b>{% endif %}
      {% if include_inactive %} + <b>INACTIVOS</b>{% endif %}
    </div>
  </div>

  {% if filtered %}
    {% for u in filtered %}
      <div class="rowline {% if u.status != 'ACTIVE' %}is-inactive{% endif %}">
        <div>
          <div class="rowtitle">
            <b>{{ u.usuario_red }}</b>
            {% if u.status == "ACTIVE" %}
              <span class="badge badge-ok">ACTIVO</span>
            {% else %}
              <span class="badge badge-bad">INACTIVO</span>
            {% endif %}

            {% if (u.vpn_activo or "")|upper == "SI" %}
              <span class="chip">VPN: SI</span>
            {% else %}
              <span class="chip ghost">VPN: NO</span>
            {% endif %}

            {% if (u.permisos_activos or "")|upper == "SI" %}
              <span class="chip">Permisos: SI</span>
            {% else %}
              <span class="chip ghost">Permisos: NO</span>
            {% endif %}

            {% if (u.acceso_redes_sociales or "")|upper == "SI" %}
              <span class="chip">Redes: SI</span>
            {% else %}
              <span class="chip ghost">Redes: NO</span>
            {% endif %}

            <span class="chip ghost">Nivel: {{ (u.acceso_nivel or "NORMAL")|upper }}</span>
          </div>

          <div class="muted" style="margin-top:6px;">
            {{ u.nombres }} {{ u.apellidos }} ‚Äî {{ u.sede }} / {{ u.dependencia }} / {{ u.subdependencia }}
          </div>

          <div class="muted" style="margin-top:6px; font-size:13px;">
            Contrato fin: <b>{{ u.contrato_fin or "‚Äî" }}</b> |
            Permiso fin: <b>{{ u.permiso_fin or "‚Äî" }}</b> |
            VPN fin: <b>{{ u.vpn_fin or "‚Äî" }}</b>
          </div>
        </div>

        <div class="rowactions">
          <button class="btn ghost" type="button" onclick='viewUser({{ u|tojson }})'>üëÅ Ver</button>

          {% if user.role == "ADMIN" %}
            <button class="btn ghost" type="button" onclick='editUser({{ u|tojson }})'>‚úè Editar</button>

            {% if u.status == "ACTIVE" %}
              <form method="post" action="{{ url_for('users.user_deactivate') }}">
                <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
                <button class="btn danger">‚õî Desactivar</button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('users.user_activate') }}">
                <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
                <button class="btn success">‚úÖ Reactivar</button>
              </form>
            {% endif %}

            <form method="post" action="{{ url_for('users.user_perms_off') }}">
              <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
              <button class="btn ghost" type="submit">üîí Apagar permisos</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="muted" style="margin-top:10px;">No hay resultados con esos filtros.</div>
  {% endif %}
</div>

<!-- =========================================================
     SECCI√ìN 2: DASHBOARD (abajo) - amCharts
========================================================= -->
<div class="card dash" style="margin-top:18px;">
  <div class="card-head dash__head">
    <div>
      <h3 style="margin:0;">üìä Dashboard</h3>
      <div class="muted">KPIs y gr√°ficos (visi√≥n general) ‚Äî datos de usuarios ACTIVOS</div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="dash__kpis">
    <div class="kpiCard">
      <div class="kpi-label">Total usuarios activos</div>
      <div class="kpi-value">{{ total }}</div>
    </div>

    <div class="kpiCard">
      <div class="kpi-label">Resultados filtrados</div>
      <div class="kpi-value">{{ total_filtrados }}</div>
    </div>

    <div class="kpiCard">
      <div class="kpi-label">Alertas (15 d√≠as)</div>
      <div class="kpi-value">{{ alerts|length }}</div>
    </div>

    <div class="kpiCard">
      <div class="kpi-label">M√©tricas BST</div>
      <div class="kpi-value" style="font-size:22px;">{{ metrics.comparisons }} comps</div>
      <div class="muted" style="font-size:13px;">comparaciones √∫ltima b√∫squeda</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="dash__grid">
    <div class="dashCard">
  <div class="dashCard__head">
    <h4 class="dashTitle">Usuarios activos por sede</h4>
  </div>
  <div class="chartBox">
    <div id="chartSede" class="chart"></div>
  </div>
</div>

<div class="dashCard">
  <div class="dashCard__head">
    <h4 class="dashTitle">Usuarios por tipo contrato</h4>
  </div>
  <div class="chartBox">
    <div id="chartContrato" class="chart"></div>
  </div>
</div>

<div class="dashCard">
  <div class="dashCard__head">
    <h4 class="dashTitle">Permisos activos</h4>
  </div>
  <div class="chartBox">
    <div id="chartPermisos" class="chart"></div>
  </div>
</div>

<div class="dashCard">
  <div class="dashCard__head">
    <h4 class="dashTitle">VPN activo</h4>
  </div>
  <div class="chartBox">
    <div id="chartVPN" class="chart"></div>
  </div>
</div>

<div class="dashCard spanAll">
  <div class="dashCard__head">
    <h4 class="dashTitle">Top dependencias (Top 10 + Otros)</h4>
  </div>
  <div class="chartBox tall">
    <div id="chartDep" class="chartTall"></div>
  </div>
</div>

<div class="dashCard spanAll">
  <div class="dashCard__head">
    <h4 class="dashTitle">Top subdependencias (Top 10 + Otros)</h4>
  </div>
  <div class="chartBox tall">
    <div id="chartSub" class="chartTall"></div>
  </div>
</div>
</div>

<!-- ================= MODAL (CREATE/EDIT/VIEW) ================= -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>

    <h3 id="modalTitle" style="margin-top:0;">Registrar Usuario</h3>

    <form method="post" action="{{ url_for('users.register_network_user') }}" class="grid2" id="userForm">
      <div style="grid-column:1/-1;">
        <h4 style="margin:6px 0;">Datos personales</h4>
      </div>

      <div>
        <label class="label">Usuario red</label>
        <input class="input" name="usuario_red" id="usuario_red" required>
      </div>
      <div>
        <label class="label">DNI</label>
        <input class="input" name="dni" id="dni">
      </div>
      <div>
        <label class="label">Nombres</label>
        <input class="input" name="nombres" id="nombres">
      </div>
      <div>
        <label class="label">Apellidos</label>
        <input class="input" name="apellidos" id="apellidos">
      </div>

      <div style="grid-column:1/-1;">
        <h4 style="margin:6px 0;">Contrato</h4>
      </div>

      <div>
        <label class="label">Tipo contrato</label>
        <select class="input" name="tipo_contrato" id="tipo_contrato">
          <option value="">Seleccione</option>
          <option value="CAS">CAS</option>
          <option value="CAP">CAP</option>
          <option value="TERCERO">TERCERO</option>
        </select>
      </div>
      <div>
        <label class="label">Inicio contrato</label>
        <input class="input" type="date" name="contrato_inicio" id="contrato_inicio">
      </div>
      <div>
        <label class="label">Fin contrato</label>
        <input class="input" type="date" name="contrato_fin" id="contrato_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4 style="margin:6px 0;">Ubicaci√≥n</h4>
      </div>

      <div>
        <label class="label">Sede</label>
        <input class="input" name="sede" id="sede">
      </div>
      <div>
        <label class="label">Dependencia</label>
        <input class="input" name="dependencia" id="dependencia">
      </div>
      <div>
        <label class="label">Subdependencia</label>
        <input class="input" name="subdependencia" id="subdependencia">
      </div>

      <div style="grid-column:1/-1;">
        <h4 style="margin:6px 0;">Permisos</h4>
      </div>

      <div>
        <label class="label">Nivel de acceso</label>
        <select class="input" name="acceso_nivel" id="acceso_nivel">
          <option value="NORMAL">NORMAL</option>
          <option value="ADMINISTRADOR">ADMINISTRADOR</option>
        </select>
      </div>

      <div>
        <label class="label">Acceso redes sociales</label>
        <select class="input" name="acceso_redes_sociales" id="acceso_redes_sociales">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label class="label">Permiso inicio</label>
        <input class="input" type="date" name="permiso_inicio" id="permiso_inicio">
      </div>
      <div>
        <label class="label">Permiso fin</label>
        <input class="input" type="date" name="permiso_fin" id="permiso_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4 style="margin:6px 0;">VPN</h4>
      </div>

      <div>
        <label class="label">VPN activo</label>
        <select class="input" name="vpn_activo" id="vpn_activo">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>
      <div>
        <label class="label">VPN inicio</label>
        <input class="input" type="date" name="vpn_inicio" id="vpn_inicio">
      </div>
      <div>
        <label class="label">VPN fin</label>
        <input class="input" type="date" name="vpn_fin" id="vpn_fin">
      </div>

      <div style="grid-column:1/-1;">
        <button class="btn" id="saveBtn" style="width:100%; margin-top:10px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- amCharts 5 -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<script>
function openModal(mode){
  document.getElementById("modal").style.display = "block";
  const title = document.getElementById("modalTitle");
  const saveBtn = document.getElementById("saveBtn");
  const form = document.getElementById("userForm");

  if(mode === "view"){
    title.innerText = "Ver usuario";
    saveBtn.style.display = "none";
    form.querySelectorAll("input,select").forEach(el => el.disabled = true);
  } else {
    title.innerText = mode === "edit" ? "Editar usuario" : "Registrar usuario";
    saveBtn.style.display = "block";
    form.querySelectorAll("input,select").forEach(el => el.disabled = false);
    document.getElementById("usuario_red").readOnly = (mode === "edit");
  }
}

function closeModal(){
  document.getElementById("modal").style.display = "none";
  const form = document.getElementById("userForm");
  form.reset();
  form.querySelectorAll("input,select").forEach(el => el.disabled = false);
  document.getElementById("saveBtn").style.display = "block";
  document.getElementById("usuario_red").readOnly = false;
}

function fillForm(data){
  const map = [
    "usuario_red","dni","nombres","apellidos",
    "tipo_contrato","contrato_inicio","contrato_fin",
    "sede","dependencia","subdependencia",
    "acceso_nivel","acceso_redes_sociales",
    "permiso_inicio","permiso_fin",
    "vpn_activo","vpn_inicio","vpn_fin"
  ];

  map.forEach(k => {
    const el = document.getElementById(k);
    if(!el) return;
    el.value = (data[k] ?? "");
  });
}

function editUser(data){
  openModal("edit");
  fillForm(data);
}

function viewUser(data){
  openModal("view");
  fillForm(data);
}

async function fetchData(url){
  const res = await fetch(url, { headers: { "Accept": "application/json" }});
  return await res.json();
}

/* ======= XY Column Chart (ENTEROS + rango limpio) ======= */
function renderXYColumn(divId, data){
  const root = am5.Root.new(divId);
  root.setThemes([am5themes_Animated.new(root)]);

  // Formato global (enteros)
  root.numberFormatter.setAll({ numberFormat: "#,###" });

  const chart = root.container.children.push(
    am5xy.XYChart.new(root, {
      panX: true, panY: false,
      wheelX: "panX", wheelY: "zoomX",
      paddingLeft: 10, paddingRight: 10,
      paddingTop: 10, paddingBottom: 10
    })
  );

  const xRenderer = am5xy.AxisRendererX.new(root, { minGridDistance: 28 });
  xRenderer.labels.template.setAll({
    oversizedBehavior: "wrap",
    maxWidth: 120,
    textAlign: "center"
  });

  const xAxis = chart.xAxes.push(
    am5xy.CategoryAxis.new(root, {
      categoryField: "category",
      renderer: xRenderer
    })
  );

  const yRenderer = am5xy.AxisRendererY.new(root, {});
  const yAxis = chart.yAxes.push(
    am5xy.ValueAxis.new(root, {
      renderer: yRenderer,
      min: 0,
      strictMinMax: true
    })
  );

  // ‚úÖ fuerza etiquetas enteras
  yRenderer.labels.template.setAll({
    text: "{value.formatNumber('#,###')}"
  });

  const series = chart.series.push(
    am5xy.ColumnSeries.new(root, {
      xAxis, yAxis,
      valueYField: "value",
      categoryXField: "category",
      tooltip: am5.Tooltip.new(root, {
        labelText: "{categoryX}: {valueY.formatNumber('#,###')}"
      })
    })
  );

  series.columns.template.setAll({
    cornerRadiusTL: 10,
    cornerRadiusTR: 10
  });

  xAxis.data.setAll(data);
  series.data.setAll(data);

  // ‚úÖ max entero (evita 1.85‚Äì2.15)
  const maxVal = Math.max(...data.map(d => Number(d.value || 0)), 0);
  yAxis.setAll({
    max: Math.max(1, Math.ceil(maxVal)),
    extraMax: 0
  });

  series.appear(900);
  chart.appear(900, 100);
}


/* ======= Horizontal Bar (ENTEROS + rango limpio) ======= */
function renderXYBar(divId, data){
  const root = am5.Root.new(divId);
  root.setThemes([am5themes_Animated.new(root)]);

  root.numberFormatter.setAll({ numberFormat: "#,###" });

  const chart = root.container.children.push(
    am5xy.XYChart.new(root, {
      panY: true,
      wheelY: "panY",
      paddingLeft: 12, paddingRight: 12,
      paddingTop: 10, paddingBottom: 10
    })
  );

  const yRenderer = am5xy.AxisRendererY.new(root, { inversed: true });
  yRenderer.labels.template.setAll({
    oversizedBehavior: "wrap",
    maxWidth: 240
  });

  const yAxis = chart.yAxes.push(
    am5xy.CategoryAxis.new(root, {
      categoryField: "category",
      renderer: yRenderer
    })
  );

  const xRenderer = am5xy.AxisRendererX.new(root, {});
  const xAxis = chart.xAxes.push(
    am5xy.ValueAxis.new(root, {
      renderer: xRenderer,
      min: 0,
      strictMinMax: true
    })
  );

  // ‚úÖ enteros
  xRenderer.labels.template.setAll({
    text: "{value.formatNumber('#,###')}"
  });

  const series = chart.series.push(
    am5xy.ColumnSeries.new(root, {
      xAxis, yAxis,
      valueXField: "value",
      categoryYField: "category",
      tooltip: am5.Tooltip.new(root, {
        labelText: "{categoryY}: {valueX.formatNumber('#,###')}"
      })
    })
  );

  series.columns.template.setAll({
    cornerRadiusTR: 10,
    cornerRadiusBR: 10
  });

  yAxis.data.setAll(data);
  series.data.setAll(data);

  const maxVal = Math.max(...data.map(d => Number(d.value || 0)), 0);
  xAxis.setAll({
    max: Math.max(1, Math.ceil(maxVal)),
    extraMax: 0
  });

  series.appear(900);
  chart.appear(900, 100);
}


/* ======= Donut (CENTRADO + SIN CORTE) ======= */
function renderDonut(divId, data){
  const root = am5.Root.new(divId);
  root.setThemes([am5themes_Animated.new(root)]);

  root.numberFormatter.setAll({ numberFormat: "#,###" });

  const chart = root.container.children.push(
    am5percent.PieChart.new(root, {
      // ‚úÖ padding controlado para que no se vaya a la esquina
      paddingTop: 10,
      paddingBottom: 10,
      paddingLeft: 10,
      paddingRight: 10
    })
  );

  const series = chart.series.push(
    am5percent.PieSeries.new(root, {
      valueField: "value",
      categoryField: "category",
      alignLabels: false,
      tooltip: am5.Tooltip.new(root, {
        labelText: "{category}: {value.formatNumber('#,###')}"
      })
    })
  );

  // ‚úÖ centrado real
  series.setAll({
    centerX: am5.percent(50),
    centerY: am5.percent(50),
    radius: am5.percent(85),
    innerRadius: am5.percent(60)
  });

  // ‚úÖ evita que etiquetas/ticks empujen el donut (causa el ‚Äúcorte‚Äù)
  series.labels.template.setAll({ forceHidden: true });
  series.ticks.template.setAll({ forceHidden: true });

  // (Opcional) si quieres ver legend bonito abajo, usa esto,
  // pero NO uses verticalLayout en el chart (eso suele descentrar):
  const legend = chart.children.push(
    am5.Legend.new(root, {
      centerX: am5.percent(50),
      x: am5.percent(50),
      layout: root.horizontalLayout,
      marginTop: 8
    })
  );
  legend.labels.template.setAll({ fontSize: 12 });
  legend.valueLabels.template.setAll({ fontSize: 12 });

  series.data.setAll(data);
  legend.data.setAll(series.dataItems);

  series.appear(900, 100);
}

(async function initCharts(){
  const sede     = await fetchData("{{ url_for('users.api_chart_sede') }}?v={{ now_ts }}");
  const contrato = await fetchData("{{ url_for('users.api_chart_contrato') }}?v={{ now_ts }}");
  const permisos = await fetchData("{{ url_for('users.api_chart_permisos') }}?v={{ now_ts }}");
  const vpn      = await fetchData("{{ url_for('users.api_chart_vpn') }}?v={{ now_ts }}");
  const dep      = await fetchData("{{ url_for('users.api_chart_dependencia') }}?v={{ now_ts }}");
  const sub      = await fetchData("{{ url_for('users.api_chart_subdependencia') }}?v={{ now_ts }}");

  renderXYColumn("chartSede", sede);
  renderDonut("chartContrato", contrato);
  renderDonut("chartPermisos", permisos);
  renderDonut("chartVPN", vpn);

  renderXYBar("chartDep", dep);
  renderXYBar("chartSub", sub);
})();
</script>

{% endblock %}