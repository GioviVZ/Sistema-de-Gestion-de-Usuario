{% extends "base.html" %}
{% block title %}Dashboard | Access UTI{% endblock %}

{% block content %}

<!-- ================== HEADER ================== -->
<div class="page-head">
  <div>
    <h2 class="h2">AccessUTI</h2>
    <div class="muted">Gesti√≥n integral de usuarios de red (consulta + tablero)</div>
  </div>

  {% if user.role == "ADMIN" %}
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <a class="btn ghost" href="{{ url_for('users.export_users') }}">‚¨á Exportar CSV</a>
    <button class="btn" type="button" onclick="openModal('create')">+ Registrar Usuario</button>
  </div>
{% endif %}
</div>

<!-- =========================================================
     SECCI√ìN 1: CONSULTA
========================================================= -->
<div class="card">
  <div class="card-head">
    <div>
      <h3 style="margin:0;">üîé Consulta</h3>
      <div class="muted">Busca usuarios y filtra por sede / dependencia / estado + permisos especiales</div>
    </div>
  </div>

  <form method="get" class="grid2" style="margin-top:14px;">
    <div>
      <label class="label">Nombre / Usuario de red</label>
      <input class="input" name="nombre" value="{{ nombre }}" placeholder="Ej: jlopez o Juan L√≥pez">
    </div>

    <div>
      <label class="label">Sede</label>
      <input class="input" name="sede" value="{{ sede }}" placeholder="Ej: Sede Central">
    </div>

    <div>
      <label class="label">Dependencia</label>
      <input class="input" name="dependencia" value="{{ dependencia }}" placeholder="Ej: Gerencia General">
    </div>

    <div>
      <label class="label">Subdependencia</label>
      <input class="input" name="subdependencia" value="{{ subdependencia }}" placeholder="Ej: Unidad de Tecnologia de la Informacion">
    </div>

    <div>
      <label class="label">Estado</label>
      <select class="input" name="estado">
        <option value="" {% if not estado %}selected{% endif %}>Activos (por defecto)</option>
        <option value="ACTIVE" {% if estado=="ACTIVE" %}selected{% endif %}>Solo ACTIVOS</option>
        <option value="INACTIVE" {% if estado=="INACTIVE" %}selected{% endif %}>Solo INACTIVOS</option>
      </select>
    </div>

    <div>
      <label class="label">Permisos activos</label>
      <select class="input" name="permisos_activos">
        <option value="" {% if not permisos_activos %}selected{% endif %}>Todos</option>
        <option value="SI" {% if permisos_activos=="SI" %}selected{% endif %}>SI</option>
        <option value="NO" {% if permisos_activos=="NO" %}selected{% endif %}>NO</option>
      </select>
    </div>

    <div>
      <label class="label">VPN</label>
      <select class="input" name="vpn_activo">
        <option value="" {% if not vpn_activo %}selected{% endif %}>Todos</option>
        <option value="SI" {% if vpn_activo=="SI" %}selected{% endif %}>SI</option>
        <option value="NO" {% if vpn_activo=="NO" %}selected{% endif %}>NO</option>
      </select>
    </div>

    <div>
      <label class="label">Redes sociales</label>
      <select class="input" name="acceso_redes_sociales">
        <option value="" {% if not acceso_redes_sociales %}selected{% endif %}>Todos</option>
        <option value="SI" {% if acceso_redes_sociales=="SI" %}selected{% endif %}>SI</option>
        <option value="NO" {% if acceso_redes_sociales=="NO" %}selected{% endif %}>NO</option>
      </select>
    </div>

    <div>
      <label class="label">Nivel de acceso</label>
      <select class="input" name="acceso_nivel">
        <option value="" {% if not acceso_nivel %}selected{% endif %}>Todos</option>
        <option value="NORMAL" {% if acceso_nivel=="NORMAL" %}selected{% endif %}>NORMAL</option>
        <option value="ADMINISTRADOR" {% if acceso_nivel=="ADMINISTRADOR" %}selected{% endif %}>ADMINISTRADOR</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">
      <label style="display:flex; gap:8px; align-items:center; margin:0;">
        <input type="checkbox" name="include_inactive" {% if include_inactive %}checked{% endif %}>
        <span class="muted">Mostrar tambi√©n desactivados</span>
      </label>
      <button class="btn" style="margin-left:auto;">Filtrar</button>
      <a class="btn ghost" href="{{ url_for('users.dashboard') }}">Limpiar</a>
    </div>
  </form>
</div>

<!-- ================= RESULTADOS ================= -->
<div class="card" style="margin-top:16px;">
  <div class="card-head">
    <div>
      <h3 style="margin:0;">üìã Resultados</h3>
      <div class="muted">
        {% if filtered %}{{ filtered|length }} resultado(s){% else %}Sin resultados{% endif %}
      </div>
    </div>

    <div class="muted" style="font-size:13px;">
      Mostrando: {% if estado %}<b>{{ estado }}</b>{% else %}<b>ACTIVE (por defecto)</b>{% endif %}
      {% if include_inactive %} + <b>INACTIVOS</b>{% endif %}
    </div>
  </div>

  {% if filtered %}
    {% for u in filtered %}
      <div class="rowline {% if u.status != 'ACTIVE' %}is-inactive{% endif %}">
        <div>
          <div class="rowtitle">
            <b>{{ u.usuario_red }}</b>
            {% if u.status == "ACTIVE" %}
              <span class="badge badge-ok">ACTIVO</span>
            {% else %}
              <span class="badge badge-bad">INACTIVO</span>
            {% endif %}

            <span class="chip ghost">Nivel: {{ (u.acceso_nivel or "NORMAL")|upper }}</span>
          </div>

          <div class="muted" style="margin-top:6px;">
            {{ u.nombres }} {{ u.apellidos }} ‚Äî {{ u.sede }} / {{ u.dependencia }} / {{ u.subdependencia }}
          </div>

          <div class="muted" style="margin-top:6px; font-size:13px;">
            Contrato fin: <b>{{ u.contrato_fin or "‚Äî" }}</b> |
            Permiso fin: <b>{{ u.permiso_fin or "‚Äî" }}</b> |
            VPN fin: <b>{{ u.vpn_fin or "‚Äî" }}</b>
          </div>
        </div>

        <div class="rowactions">
          <button class="btn ghost" type="button" onclick='viewUser({{ u|tojson }})'>üëÅ Ver</button>

          {% if user.role == "ADMIN" %}
            <button class="btn ghost" type="button" onclick='editUser({{ u|tojson }})'>‚úè Editar</button>

            {% if u.status == "ACTIVE" %}
              <form method="post" action="{{ url_for('users.user_deactivate') }}">
                <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
                <button class="btn danger">‚õî Desactivar</button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('users.user_activate') }}">
                <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
                <button class="btn success">‚úÖ Reactivar</button>
              </form>
            {% endif %}

            <form method="post" action="{{ url_for('users.user_perms_off') }}">
              <input type="hidden" name="usuario_red" value="{{ u.usuario_red }}">
              <button class="btn ghost" type="submit">üîí Apagar permisos</button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="muted" style="margin-top:10px;">No hay resultados con esos filtros.</div>
  {% endif %}
</div>
{% if user.role == "ADMIN" %}
  <a class="btn ghost" href="{{ url_for('users.export_users') }}">‚¨á Exportar CSV</a>
{% endif %}

<!-- ================= ALERTAS ================= -->
<div class="card" style="margin-top:16px;">
  <div class="card-head">
    <div>
      <h3 style="margin:0;">‚è∞ Alertas de vencimiento (15 d√≠as)</h3>
      <div class="muted">Contrato / Permisos / VPN / Antivirus (si aplica)</div>
    </div>
    <div class="muted" style="font-size:13px;">
      Total: <b>{{ alerts|length }}</b>
    </div>
  </div>

  {% if alerts and alerts|length > 0 %}
    {% for a in alerts %}
      <div class="rowline">
        <div>
          <div class="rowtitle">
            <b>{{ a.u.usuario_red }}</b>
            <span class="chip ghost">{{ a.tipo }}</span>
            {% if a.dias < 0 %}
              <span class="badge badge-bad">VENCIDO</span>
            {% else %}
              <span class="badge badge-ok">Faltan {{ a.dias }} d√≠a(s)</span>
            {% endif %}
          </div>

          <div class="muted" style="margin-top:6px;">
            {{ a.u.nombres }} {{ a.u.apellidos }} ‚Äî {{ a.u.sede }} / {{ a.u.dependencia }}
          </div>

          <div class="muted" style="margin-top:6px; font-size:13px;">
            Vence: <b>{{ a.vence }}</b>
            {% if a.tipo == "ANTIVIRUS" %}
              | Equipo personal: <b>{{ a.u.equipo_personal or "NO" }}</b>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="muted" style="margin-top:10px;">Sin alertas pr√≥ximas.</div>
  {% endif %}
</div>

<!-- ================= AUDITOR√çA ================= -->
<div class="card" style="margin-top:16px;">
  <div class="card-head">
    <div>
      <h3 style="margin:0;">üßæ Auditor√≠a (√∫ltimos movimientos)</h3>
      <div class="muted">Registro reciente de acciones administrativas</div>
    </div>
    <div class="muted" style="font-size:13px;">
      Total: <b>{{ audit_events|length }}</b>
    </div>
  </div>

  {% if audit_events and audit_events|length > 0 %}
    {% for ev in audit_events %}
      <div class="rowline">
        <div>
          <div class="rowtitle">
            <span class="chip ghost">üë§ {{ ev.actor }}</span>
            <span class="badge badge-ok">Acci√≥n</span>
          </div>

          <div style="margin-top:6px;">
            {{ ev.action }}
          </div>

          <div class="muted" style="margin-top:6px; font-size:13px;">
            üïí {{ ev.ts }}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="muted" style="margin-top:10px;">A√∫n no hay eventos registrados.</div>
  {% endif %}
</div>
<!-- ================= DASHBOARD ================= -->
<div id="dashboard" class="card dash" style="margin-top:18px;">

<div class="card dash" style="margin-top:18px;">
  <div class="card-head dash__head">
    <div>
      <h3 style="margin:0;">üìä Dashboard</h3>
      <div class="muted">KPIs y gr√°ficos (visi√≥n general) ‚Äî datos de usuarios ACTIVOS</div>
    </div>
  </div>

  <div class="dash__kpis">
    <div class="kpiCard">
      <div class="kpi-label">Total usuarios activos</div>
      <div class="kpi-value">{{ total }}</div>
    </div>

    <div class="kpiCard">
      <div class="kpi-label">Resultados filtrados</div>
      <div class="kpi-value">{{ total_filtrados }}</div>
    </div>

    <div class="kpiCard">
      <div class="kpi-label">Alertas (15 d√≠as)</div>
      <div class="kpi-value">{{ alerts|length }}</div>
    </div>

    <div class="kpiCard">
      <div class="kpi-label">M√©tricas BST</div>
      <div class="kpi-value" style="font-size:22px;">{{ metrics.comparisons }} comps</div>
      <div class="muted" style="font-size:13px;">comparaciones √∫ltima b√∫squeda</div>
    </div>
  </div>

  <div class="dash__grid">
    <div class="dashCard">
      <div class="dashCard__head"><h4 class="dashTitle">Usuarios activos por sede</h4></div>
      <div class="chartBox"><div id="chartSede" class="chart"></div></div>
    </div>

    <div class="dashCard">
      <div class="dashCard__head"><h4 class="dashTitle">Usuarios por tipo contrato</h4></div>
      <div class="chartBox"><div id="chartContrato" class="chart"></div></div>
    </div>

    <div class="dashCard">
      <div class="dashCard__head"><h4 class="dashTitle">Permisos activos</h4></div>
      <div class="chartBox"><div id="chartPermisos" class="chart"></div></div>
    </div>

    <div class="dashCard">
      <div class="dashCard__head"><h4 class="dashTitle">VPN activo</h4></div>
      <div class="chartBox"><div id="chartVPN" class="chart"></div></div>
    </div>

    <div class="dashCard spanAll">
      <div class="dashCard__head"><h4 class="dashTitle">Top dependencias (Top 10 + Otros)</h4></div>
      <div class="chartBox tall"><div id="chartDep" class="chartTall"></div></div>
    </div>

    <div class="dashCard spanAll">
      <div class="dashCard__head"><h4 class="dashTitle">Top subdependencias (Top 10 + Otros)</h4></div>
      <div class="chartBox tall"><div id="chartSub" class="chartTall"></div></div>
    </div>
  </div>
</div>

<!-- ================= MODAL (CREATE/EDIT/VIEW) ================= -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>

    <h3 id="modalTitle" style="margin-top:0;">Registrar Usuario</h3>

    <form method="post" action="{{ url_for('users.register_network_user') }}" class="grid2" id="userForm">
      <div style="grid-column:1/-1;"><h4 style="margin:6px 0;">Datos personales</h4></div>

      <div>
        <label class="label">Usuario red</label>
        <input class="input" name="usuario_red" id="usuario_red" required>
      </div>
      <div>
        <label class="label">DNI</label>
        <input class="input" name="dni" id="dni">
      </div>
      <div>
        <label class="label">Nombres</label>
        <input class="input" name="nombres" id="nombres">
      </div>
      <div>
        <label class="label">Apellidos</label>
        <input class="input" name="apellidos" id="apellidos">
      </div>
      <div>
        <label class="label">Correo</label>
        <input class="input" name="correo" id="correo" placeholder="usuario@inia.gob.pe">
      </div>
      <div>
        <label class="label">IP</label>
        <input class="input" name="ip_equipo" id="ip_equipo" placeholder="192.168.1.10">
      </div>
      <div>
        <label class="label">Host</label>
        <input class="input" name="host" id="host" placeholder="PC-UTI-001">
      </div>

      <div style="grid-column:1/-1;"><h4 style="margin:6px 0;">Contrato</h4></div>

      <div>
        <label class="label">Tipo contrato</label>
        <select class="input" name="tipo_contrato" id="tipo_contrato">
          <option value="">Seleccione</option>
          <option value="CAS">CAS</option>
          <option value="CAP">CAP</option>
          <option value="TERCERO">TERCERO</option>
          <option value="PRACTICANTE">PRACTICANTE</option>
        </select>
      </div>
      <div>
        <label class="label">Inicio contrato</label>
        <input class="input" type="date" name="contrato_inicio" id="contrato_inicio">
      </div>
      <div>
        <label class="label">Fin contrato</label>
        <input class="input" type="date" name="contrato_fin" id="contrato_fin">
      </div>

      <div style="grid-column:1/-1;">
        <h4 style="margin:6px 0;">Ubicaci√≥n</h4>
        <div class="muted" style="font-size:12px;">Combos desde <b>static/data/org.json</b></div>
      </div>

      <div>
        <label class="label">Sede</label>
        <select class="input" name="sede" id="sede">
          <option value="">Cargando sedes...</option>
        </select>
      </div>
      <div>
        <label class="label">Dependencia</label>
        <select class="input" name="dependencia" id="dependencia">
          <option value="">Seleccione sede primero</option>
        </select>
      </div>
      <div>
        <label class="label">Subdependencia</label>
        <select class="input" name="subdependencia" id="subdependencia">
          <option value="">Seleccione dependencia primero</option>
        </select>
      </div>

      <div style="grid-column:1/-1;"><h4 style="margin:6px 0;">Permisos</h4></div>

      <div>
        <label class="label">Nivel de acceso</label>
        <select class="input" name="acceso_nivel" id="acceso_nivel">
          <option value="NORMAL">NORMAL</option>
          <option value="ADMINISTRADOR">ADMINISTRADOR</option>
        </select>
      </div>
      <div>
        <label class="label">Acceso redes sociales</label>
        <select class="input" name="acceso_redes_sociales" id="acceso_redes_sociales">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label class="label">Permisos activos</label>
        <select class="input" name="permisos_activos" id="permisos_activos">
          <option value="SI">SI</option>
          <option value="NO">NO</option>
        </select>
      </div>

      <div>
        <label class="label">Permiso inicio</label>
        <input class="input" type="date" name="permiso_inicio" id="permiso_inicio">
      </div>
      <div>
        <label class="label">Permiso fin</label>
        <input class="input" type="date" name="permiso_fin" id="permiso_fin">
      </div>

      <div style="grid-column:1/-1;"><h4 style="margin:6px 0;">VPN</h4></div>

      <div>
        <label class="label">VPN activo</label>
        <select class="input" name="vpn_activo" id="vpn_activo">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>
      <div>
        <label class="label">Equipo personal</label>
        <select class="input" name="equipo_personal" id="equipo_personal">
          <option value="NO">NO</option>
          <option value="SI">SI</option>
        </select>
      </div>

      <div>
        <label class="label">Antivirus (solo si VPN=SI y Equipo personal=SI)</label>
        <input class="input" name="antivirus" id="antivirus" placeholder="Ej: ESET / Defender / Kaspersky">
      </div>
      <div>
        <label class="label">Fin Antivirus</label>
        <input class="input" type="date" name="antivirus_fin" id="antivirus_fin">
      </div>
      <div>
        <label class="label">VPN inicio</label>
        <input class="input" type="date" name="vpn_inicio" id="vpn_inicio">
      </div>
      <div>
        <label class="label">VPN fin</label>
        <input class="input" type="date" name="vpn_fin" id="vpn_fin">
      </div>

      <div style="grid-column:1/-1;">
        <button class="btn" id="saveBtn" style="width:100%; margin-top:10px;">Guardar</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <!-- amCharts 5 -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

  <!-- Vars para JS -->
  <script>
    window.ACCESSUTI = {
      orgUrl: "{{ url_for('static', filename='data/org.json') }}?v={{ now_ts }}",
      endpoints: {
        sede: "{{ url_for('users.api_chart_sede') }}?v={{ now_ts }}",
        contrato: "{{ url_for('users.api_chart_contrato') }}?v={{ now_ts }}",
        permisos: "{{ url_for('users.api_chart_permisos') }}?v={{ now_ts }}",
        vpn: "{{ url_for('users.api_chart_vpn') }}?v={{ now_ts }}",
        dep: "{{ url_for('users.api_chart_dependencia') }}?v={{ now_ts }}",
        sub: "{{ url_for('users.api_chart_subdependencia') }}?v={{ now_ts }}"
      }
    };
  </script>

  <script src="{{ url_for('static', filename='js/org-combos.js') }}?v={{ now_ts }}"></script>
  <script src="{{ url_for('static', filename='js/modal.js') }}?v={{ now_ts }}"></script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ now_ts }}"></script>
{% endblock %}