{% extends "base.html" %}
{% block title %}Editar Usuario | AccessUTI{% endblock %}

{% block content %}

<div class="page-head">
  <div>
    <h2 class="h2">Editar Usuario de Red</h2>
    <p class="muted">Actualiza ubicación, estado y accesos (Red/VPN).</p>
  </div>
</div>

{% if error %}
  <div class="banner danger">{{ error }}</div>
{% endif %}

<form method="post"
      action="?next={{ request.args.get('next','') | urlencode }}"
      class="card form-card">

  <h3 class="h3">Datos del usuario</h3>

  <div class="kv">
    <div class="item">
      <b>Usuario de red</b>
      <input value="{{ usuario.usuario_red }}" disabled>
      <small class="muted">No se puede editar.</small>
    </div>

    <div class="item">
      <b>Nombres *</b>
      <input name="nombres" value="{{ usuario.nombres }}" required>
    </div>

    <div class="item">
      <b>Tipo de contrato</b>
      <select name="tipo_contrato">
        <option value="">—</option>
        {% for c in contratos %}
          <option value="{{ c }}" {% if usuario.tipo_contrato == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="item">
      <b>Estado</b>
      <select name="estado">
        <option value="ACTIVO" {% if (usuario.estado or '').upper() == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
        <option value="INACTIVO" {% if (usuario.estado or '').upper() == 'INACTIVO' %}selected{% endif %}>INACTIVO</option>
      </select>
    </div>

    <div class="item">
      <b>Sede</b>
      <select id="sede" name="sede">
        <option value="">—</option>
        {% for s in sedes %}
          <option value="{{ s }}" {% if usuario.sede == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="item">
      <b>Dependencia</b>
      <select id="dependencia" name="dependencia">
        <option value="">—</option>
      </select>
    </div>

    <div class="item">
      <b>Subdependencia</b>
      <select id="subdependencia" name="subdependencia">
        <option value="">—</option>
      </select>
    </div>

    <div class="item">
      <b>Inicio (usuario)</b>
      <input type="date" name="fecha_inicio" value="{{ usuario.fecha_inicio }}">
    </div>

    <div class="item">
      <b>Fin (usuario)</b>
      <input type="date" name="fecha_fin" value="{{ usuario.fecha_fin }}">
    </div>
  </div>

  <hr class="sep">

  <h3 class="h3">Accesos de red</h3>

  <div class="kv">
    <div class="item">
      <b>Nivel de red</b>
      <select name="nivel_red" id="nivel_red">
        {% for n in niveles_red %}
          <option value="{{ n }}" {% if (usuario.nivel_red or '').upper() == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
      <small class="muted">Si es NORMAL, fechas se deshabilitan.</small>
    </div>

    <div class="item">
      <b>Inicio acceso red</b>
      <input type="date" name="red_inicio" id="red_inicio" value="{{ usuario.red_inicio }}">
    </div>

    <div class="item">
      <b>Fin acceso red</b>
      <input type="date" name="red_fin" id="red_fin" value="{{ usuario.red_fin }}">
    </div>
  </div>

  <hr class="sep">

  <h3 class="h3">VPN</h3>

  <div class="kv">
    <div class="item">
      <b>¿Tiene VPN?</b>
      <select name="tiene_vpn" id="tiene_vpn">
        <option value="NO" {% if (usuario.tiene_vpn or '').upper() == 'NO' %}selected{% endif %}>NO</option>
        <option value="SI" {% if (usuario.tiene_vpn or '').upper() == 'SI' %}selected{% endif %}>SI</option>
      </select>
      <small class="muted">Si es NO, fechas se deshabilitan.</small>
    </div>

    <div class="item">
      <b>Inicio VPN</b>
      <input type="date" name="vpn_inicio" id="vpn_inicio" value="{{ usuario.vpn_inicio }}">
    </div>

    <div class="item">
      <b>Fin VPN</b>
      <input type="date" name="vpn_fin" id="vpn_fin" value="{{ usuario.vpn_fin }}">
    </div>
  </div>

  <div class="actions-row">
    <button class="btn" type="submit">Guardar cambios</button>

    {% if request.args.get('next') %}
      <a class="btn ghost" href="{{ request.args.get('next') }}">Volver</a>
    {% else %}
      <a class="btn ghost" href="{{ url_for('consulta_usuario_red', ver=usuario.usuario_red) }}">Cancelar</a>
    {% endif %}
  </div>
</form>

<script>
  const MAP_SEDE_DIR = {{ map_sede_dir_json | safe }};
  const MAP_DIR_SUB  = {{ map_dir_sub_json  | safe }};

  const sedeSel = document.getElementById("sede");
  const depSel  = document.getElementById("dependencia");
  const subSel  = document.getElementById("subdependencia");

  // valores actuales (para precargar)
  const selectedDep = "{{ usuario.dependencia or '' }}";
  const selectedSub = "{{ usuario.subdependencia or '' }}";

  function setOptions(selectEl, items, placeholder) {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    (items || []).forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    });
  }

  function onSedeChange(init=false) {
    const sede = sedeSel.value;
    const deps = MAP_SEDE_DIR[sede] || [];
    setOptions(depSel, deps, "—");
    setOptions(subSel, [], "—");

    if (init && selectedDep && deps.includes(selectedDep)) {
      depSel.value = selectedDep;
      onDepChange(true);
    }
  }

  function onDepChange(init=false) {
    const dep = depSel.value;
    const subs = MAP_DIR_SUB[dep] || [];
    setOptions(subSel, subs, "—");

    if (init && selectedSub && subs.includes(selectedSub)) {
      subSel.value = selectedSub;
    }
  }

  sedeSel.addEventListener("change", () => onSedeChange(false));
  depSel.addEventListener("change", () => onDepChange(false));

  // UX: habilitar/deshabilitar fechas por selección
  const nivelSel = document.getElementById("nivel_red");
  const redIni   = document.getElementById("red_inicio");
  const redFin   = document.getElementById("red_fin");

  const vpnSel   = document.getElementById("tiene_vpn");
  const vpnIni   = document.getElementById("vpn_inicio");
  const vpnFin   = document.getElementById("vpn_fin");

  function toggleRedFechas() {
    const nivel = (nivelSel.value || "NORMAL").toUpperCase();
    const enable = (nivel !== "NORMAL");
    redIni.disabled = !enable;
    redFin.disabled = !enable;
    if (!enable) { redIni.value = ""; redFin.value = ""; }
  }

  function toggleVpnFechas() {
    const v = (vpnSel.value || "NO").toUpperCase();
    const enable = (v === "SI");
    vpnIni.disabled = !enable;
    vpnFin.disabled = !enable;
    if (!enable) { vpnIni.value = ""; vpnFin.value = ""; }
  }

  nivelSel.addEventListener("change", toggleRedFechas);
  vpnSel.addEventListener("change", toggleVpnFechas);

  // init
  onSedeChange(true);
  toggleRedFechas();
  toggleVpnFechas();
</script>

{% endblock %}